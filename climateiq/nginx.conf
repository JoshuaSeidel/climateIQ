# ClimateIQ Nginx Ingress Proxy Configuration
# Handles HA ingress path prefix and WebSocket upgrades

# Upstream for the ClimateIQ backend
upstream climateiq_backend {
    server 127.0.0.1:8420;
    keepalive 8;
}

# Map for WebSocket upgrade detection
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    listen 8099 default_server;
    server_name _;

    # Disable access log to reduce noise (HA handles its own logging)
    access_log off;
    error_log /var/log/nginx/climateiq-error.log warn;

    # Max upload size for config imports etc.
    client_max_body_size 10m;

    # Timeouts
    proxy_connect_timeout 10s;
    proxy_send_timeout 60s;
    proxy_read_timeout 300s;
    send_timeout 60s;

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript;
    gzip_min_length 256;

    # =========================================================================
    # WebSocket endpoints - must be matched before the general proxy
    # =========================================================================

    location ~* ^.*/ws(/.*)?$ {
        proxy_pass http://climateiq_backend;
        proxy_http_version 1.1;

        # WebSocket upgrade headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Standard proxy headers
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Pass the ingress path so the backend knows its prefix
        proxy_set_header X-Ingress-Path $http_x_ingress_path;

        # Long timeout for WebSocket connections
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # =========================================================================
    # API endpoints
    # =========================================================================

    location /api/ {
        proxy_pass http://climateiq_backend/api/;
        proxy_http_version 1.1;

        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Ingress-Path $http_x_ingress_path;

        # Buffering for API responses
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }

    # =========================================================================
    # Health check (direct, not through ingress auth)
    # =========================================================================

    location /health {
        proxy_pass http://climateiq_backend/health;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
    }

    # =========================================================================
    # Static frontend assets
    # =========================================================================

    location /assets/ {
        alias /app/frontend/dist/assets/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # =========================================================================
    # Default: serve frontend SPA with fallback to index.html
    # =========================================================================

    location / {
        # Try static files first, then fall back to index.html for SPA routing
        root /app/frontend/dist;
        try_files $uri $uri/ /index.html;

        # Pass ingress path header for frontend to detect
        add_header X-Ingress-Path $http_x_ingress_path always;

        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 7d;
            add_header Cache-Control "public";
        }
    }
}
